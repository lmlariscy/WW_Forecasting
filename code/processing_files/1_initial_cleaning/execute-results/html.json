{
  "hash": "e2bf2db35bda0fed264c2f85bc29f886",
  "result": {
    "markdown": "---\ntitle: \"Raw data processing\"\nauthor: \"Leah Lariscy\"\ndate: \"2023-09-01\"\nformat: html\neditor: visual\ntoc: true\ntoc-depth: 4\n---\n\n\n## Info\n\nThis script does the following:\n\n-   Loads raw data files\n\n-   Checks for missing data in all raw data files\n\n-   Converts qPCR non-detects to NAs\n\n-   Calculates LOD and LOQ values for all four assays\n\n-   Transforms NAs to LOD for each assay\n\n-   Binds all qPCR data sets with WWTP data\n\n-   Binds all DPH COVID data\n\n## Load packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(skimr)\nlibrary(here)\nlibrary(ggplot2)\nlibrary(readr)\nlibrary(dplyr)\nlibrary(stats)\n```\n:::\n\n\n## Load raw data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load N1 data\nn1_stepone_v2 <- read_csv(here(\"data/raw_data/updated_data/stepone_n1_FINAL_UPDATE.csv\")) #year 1 data\nn1_cfx_v2 <- read_csv(here(\"data/raw_data/updated_data/cfx_n1_FINAL_UPDATE.csv\")) #year 2 data\n\n# Load N2 data\nn2_stepone_v2 <- read_csv(here(\"data/raw_data/updated_data/stepone_n2_FINAL_UPDATE.csv\")) #year 1 data\nn2_cfx_v2 <- read_csv(here(\"data/raw_data/updated_data/cfx_n2_FINAL_UPDATE.csv\")) #year 2 data\n\n# Load Plant data\nplant_v2 <- read_csv(here(\"data/raw_data/updated_data/plant_data_UPDATED.csv\"))\n\n# Load COVID-19 Symptom data\ncovid_symptom <- read_csv(here(\"data/raw_data/ga_covid_data/epicurve_symptom_date.csv\")) %>% \n  filter(county==\"Clarke\") %>% \n  select(symptom.date=`symptom date`, \n         cases, moving_avg_cases)\n\n#Load COVID-19 Confirmed Case Data\ncovid_case <- read_csv(here(\"data/raw_data/ga_covid_data/epicurve_rpt_date.csv\")) %>% \n  filter(county==\"Clarke\") %>% \n  select(report_date, \n         cases, \n         moving_avg_cases)\n\n#Load COVID-19 Testing Data\ncovid_testing <- read_csv(here(\"data/raw_data/ga_covid_data/pcr_antigen_col.csv\")) %>% \n  filter(county==\"Clarke\") %>% \n  select(collection_date = collection_dt, \n         pcr_tests = `ALL PCR tests performed`, \n         pcr_pos = `All PCR positive tests`, \n         pcr_pos_7dma = `7 day percent positive`,\n         pcr_pos_14dma = `14 day percent positive`)\n\n#Load CFX recovery data\nrecovery_output <- read_csv(here(\"data/raw_data/recovery_data.csv\"))\nrecovery_input <- read_csv(here(\"data/raw_data/calfguard.csv\"))\n\n#Load Hospitalization data\n#hospitalization <- read_csv(here(\"data/raw_data/hospitalizations.csv\"))\n```\n:::\n\n\n## Create df to check for missing collections\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Year 1\nnumbers <- 7:92\nnumbers_tbl <- tibble(\"collection_num\"=numbers)\n\n#Year 2\nnumbers2 <- 93:243\nnumbers2_tbl <- tibble(\"collection_num\" =numbers2)\n\n#full time series (for plant data)\nnumbers3 <- 7:243\nnumbers3_tbl <- tibble(\"Collection\" =numbers3)\n```\n:::\n\n\n## Glance at data\n\n### StepOne N1\n\n#### Count observations for each collection number\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection date, then visualize\nn1_stepone_v2 %>% count(collection_num) %>% ggplot(aes(n)) +\n  geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nn1_stepone_v2 %>% ggplot(aes(collection_num)) + \n  geom_histogram(binwidth = 1) #max should be either 27 or 54\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n:::\n\n\n#### Count observations for each biological replicate\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each sample id/biological rep, then visualize\nn1_stepone_v2 %>% count(sample_id) %>% ggplot(aes(n)) + \n  geom_histogram() #there should be 3 technical reps\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#check which collections have more than 3 technical reps\nn1_stepone_v2 %>% count(sample_id) %>% filter(n>3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 × 2\n   sample_id     n\n   <chr>     <int>\n 1 MI_19_A       6\n 2 MI_19_B       6\n 3 MI_7_C        6\n 4 NO_19_A       6\n 5 NO_19_B       6\n 6 NO_65_B       6\n 7 NO_7_A        6\n 8 NO_7_C        9\n 9 NO_8_A        6\n10 NO_9_A        6\n```\n:::\n:::\n\n\n#### Merge data with number tibble to check missing collections\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection number\n#merge with numbers tibble to check for missing collections\ncount_n1_stepone <- n1_stepone_v2 %>% count(collection_num) \ncount_n1_stepone <- merge(count_n1_stepone, numbers_tbl, by=\"collection_num\", all.y=T)\n\ncount_n1_stepone\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   collection_num  n\n1               7 33\n2               8 21\n3               9 15\n4              10 18\n5              11 18\n6              12 18\n7              13 18\n8              14 18\n9              15 18\n10             16 18\n11             17 18\n12             18 30\n13             19 30\n14             20 18\n15             21 18\n16             22 27\n17             23 27\n18             24 27\n19             25 27\n20             26 27\n21             27 27\n22             28 27\n23             29 27\n24             30 27\n25             31 27\n26             32 24\n27             33 27\n28             34 27\n29             35 27\n30             36 27\n31             37 27\n32             38 27\n33             39 27\n34             40 NA\n35             41 27\n36             42 27\n37             43 27\n38             44 27\n39             45 27\n40             46 27\n41             47 27\n42             48 27\n43             49 27\n44             50 27\n45             51 27\n46             52 27\n47             53 27\n48             54 27\n49             55 27\n50             56 27\n51             57 27\n52             58 27\n53             59 27\n54             60 27\n55             61 27\n56             62 27\n57             63 27\n58             64 27\n59             65 57\n60             66 54\n61             67 54\n62             68 54\n63             69 54\n64             70 54\n65             71 54\n66             72 54\n67             73 54\n68             74 36\n69             75 54\n70             76 27\n71             77 54\n72             78 54\n73             79 27\n74             80 27\n75             81 54\n76             82 36\n77             83 54\n78             84 27\n79             85 54\n80             86 54\n81             87 54\n82             88 54\n83             89 54\n84             90 54\n85             91 54\n86             92 54\n```\n:::\n\n```{.r .cell-code}\n#collection 40 is missing, but this is expected\n```\n:::\n\n\n### StepOne N2\n\n#### Merge data with number tibble to check missing collections\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection number\n#merge with numbers tibble to check for missing collections\ncount_n2_stepone <- n2_stepone_v2 %>% count(collection_num) \ncount_n2_stepone <- merge(count_n2_stepone, numbers_tbl, by=\"collection_num\", all.y=T)\n\ncount_n2_stepone\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   collection_num  n\n1               7 33\n2               8 21\n3               9 15\n4              10 18\n5              11 18\n6              12 18\n7              13 18\n8              14 18\n9              15 18\n10             16 18\n11             17 18\n12             18 30\n13             19 30\n14             20 18\n15             21 18\n16             22 27\n17             23 27\n18             24 27\n19             25 27\n20             26 27\n21             27 27\n22             28 27\n23             29 27\n24             30 27\n25             31 27\n26             32 24\n27             33 27\n28             34 27\n29             35 27\n30             36 27\n31             37 27\n32             38 27\n33             39 27\n34             40 NA\n35             41 27\n36             42 27\n37             43 27\n38             44 27\n39             45 27\n40             46 27\n41             47 27\n42             48 27\n43             49 27\n44             50 27\n45             51 27\n46             52 27\n47             53 27\n48             54 27\n49             55 24\n50             56 27\n51             57 27\n52             58 27\n53             59 27\n54             60 27\n55             61 27\n56             62 27\n57             63 27\n58             64 27\n59             65 54\n60             66 54\n61             67 54\n62             68 54\n63             69 54\n64             70 54\n65             71 54\n66             72 54\n67             73 54\n68             74 35\n69             75 54\n70             76 27\n71             77 54\n72             78 53\n73             79 24\n74             80 27\n75             81 54\n76             82 36\n77             83 54\n78             84 27\n79             85 54\n80             86 54\n81             87 54\n82             88 54\n83             89 54\n84             90 54\n85             91 54\n86             92 54\n```\n:::\n\n```{.r .cell-code}\n#collection 40 is missing, but this is expected\n```\n:::\n\n\n#### Count observations for each collection number\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection date, then visualize\nn2_stepone_v2 %>% count(collection_num) %>% ggplot(aes(n)) +\n  geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nn2_stepone_v2 %>% ggplot(aes(collection_num)) + \n  geom_histogram(binwidth = 1) #max should be either 27 or 54\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n#### Count observations for each biological replicate\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each sample id/biological rep, then visualize\nn2_stepone_v2 %>% count(sample_id) %>% ggplot(aes(n)) + \n  geom_histogram() #there should be 3 technical reps\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#check which collections have more than 3 technical reps\nn2_stepone_v2 %>% count(sample_id) %>% filter(n>3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 × 2\n   sample_id     n\n   <chr>     <int>\n 1 MI_19_A       6\n 2 MI_19_B       6\n 3 MI_7_C        6\n 4 NO_19_A       6\n 5 NO_19_B       6\n 6 NO_65_B       6\n 7 NO_7_A        6\n 8 NO_7_C        9\n 9 NO_8_A        6\n10 NO_9_A        6\n```\n:::\n:::\n\n\n### CFX N1\n\n#### Merge data with number tibble to check missing collections\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection number\n#merge with numbers tibble to check for missing collections\ncount_n1_cfx <- n1_cfx_v2 %>% count(collection_num) \ncount_n1_cfx <- merge(count_n1_cfx, numbers2_tbl, by=\"collection_num\", all.y=T)\ncount_n1_cfx\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    collection_num  n\n1               93 27\n2               94 NA\n3               95 54\n4               96 54\n5               97 54\n6               98 54\n7               99 54\n8              100 54\n9              101 54\n10             102 54\n11             103 54\n12             104 54\n13             105 48\n14             106 48\n15             107 27\n16             108 27\n17             109 54\n18             110 54\n19             111 54\n20             112 54\n21             113 54\n22             114 54\n23             115 54\n24             116 54\n25             117 54\n26             118 54\n27             119 54\n28             120 54\n29             121 54\n30             122 54\n31             123 54\n32             124 54\n33             125 54\n34             126 54\n35             127 54\n36             128 54\n37             129 54\n38             130 54\n39             131 54\n40             132 54\n41             133 54\n42             134 54\n43             135 NA\n44             136 54\n45             137 54\n46             138 54\n47             139 53\n48             140 54\n49             141 54\n50             142 54\n51             143 54\n52             144 54\n53             145 54\n54             146 54\n55             147 54\n56             148 54\n57             149 54\n58             150 54\n59             151 54\n60             152 54\n61             153 54\n62             154 54\n63             155 54\n64             156 54\n65             157 54\n66             158 54\n67             159 54\n68             160 54\n69             161 54\n70             162 54\n71             163 54\n72             164 36\n73             165 36\n74             166 54\n75             167 54\n76             168 54\n77             169 54\n78             170 54\n79             171 54\n80             172 54\n81             173 54\n82             174 54\n83             175 54\n84             176 54\n85             177 NA\n86             178 54\n87             179 54\n88             180 54\n89             181 54\n90             182 54\n91             183 54\n92             184 54\n93             185 54\n94             186 54\n95             187 54\n96             188 54\n97             189 54\n98             190 54\n99             191 54\n100            192 54\n101            193 54\n102            194 54\n103            195 54\n104            196 54\n105            197 54\n106            198 54\n107            199 54\n108            200 54\n109            201 54\n110            202 54\n111            203 54\n112            204 54\n113            205 54\n114            206 54\n115            207 54\n116            208 54\n117            209 54\n118            210 27\n119            211 27\n120            212 54\n121            213 NA\n122            214 54\n123            215 54\n124            216 54\n125            217 54\n126            218 57\n127            219 54\n128            220 54\n129            221 54\n130            222 27\n131            223 27\n132            224 54\n133            225 54\n134            226 54\n135            227 54\n136            228 51\n137            229 54\n138            230 27\n139            231 27\n140            232 54\n141            233 54\n142            234 54\n143            235 54\n144            236 54\n145            237 54\n146            238 54\n147            239 54\n148            240 54\n149            241 54\n150            242 54\n151            243 54\n```\n:::\n:::\n\n\n#### Count observations for each collection number\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection date, then visualize\nn1_cfx_v2 %>% count(collection_num) %>% ggplot(aes(n)) +\n  geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\nn1_cfx_v2 %>% ggplot(aes(collection_num)) + \n  geom_histogram(binwidth = 1) #max should be 54\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n:::\n\n\n#### Check which collections are doubled\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#check which collections are doubled\ncount_n1_cfx %>% filter(n==108)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] collection_num n             \n<0 rows> (or 0-length row.names)\n```\n:::\n:::\n\n\n#### Count observations for each biological replicate\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each sample id/biological rep, then visualize\nn1_cfx_v2 %>% count(sample_id) %>% ggplot(aes(n)) + \n  geom_histogram() #there should be 3 technical reps\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#almost all have 3 replicates, but there is a small amount with 6\n\n#check which collections have more than 3 technical reps\nn1_cfx_v2 %>% count(sample_id) %>% filter(n>3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 2\n  sample_id     n\n  <chr>     <int>\n1 MI_218_C      6\n```\n:::\n:::\n\n\n### CFX N2\n\n#### Merge data with number tibble to check missing collections\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection number\n#merge with numbers tibble to check for missing collections\ncount_n2_cfx <- n2_cfx_v2 %>% count(collection_num) \ncount_n2_cfx <- merge(count_n2_cfx, numbers2_tbl, by=\"collection_num\", all.y=T)\ncount_n2_cfx\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    collection_num  n\n1               93 27\n2               94 NA\n3               95 54\n4               96 54\n5               97 54\n6               98 57\n7               99 54\n8              100 54\n9              101 54\n10             102 54\n11             103 54\n12             104 54\n13             105 48\n14             106 54\n15             107 18\n16             108 27\n17             109 54\n18             110 54\n19             111 54\n20             112 54\n21             113 54\n22             114 54\n23             115 54\n24             116 54\n25             117 54\n26             118 54\n27             119 54\n28             120 54\n29             121 54\n30             122 54\n31             123 54\n32             124 54\n33             125 54\n34             126 54\n35             127 54\n36             128 54\n37             129 54\n38             130 54\n39             131 54\n40             132 54\n41             133 54\n42             134 54\n43             135 NA\n44             136 54\n45             137 54\n46             138 54\n47             139 54\n48             140 54\n49             141 54\n50             142 54\n51             143 53\n52             144 18\n53             145 53\n54             146 53\n55             147 53\n56             148 53\n57             149 53\n58             150 53\n59             151 53\n60             152 53\n61             153 53\n62             154 53\n63             155 53\n64             156 53\n65             157 NA\n66             158 53\n67             159 53\n68             160 54\n69             161 54\n70             162 54\n71             163 54\n72             164 36\n73             165 36\n74             166 54\n75             167 48\n76             168 54\n77             169 54\n78             170 54\n79             171 54\n80             172 54\n81             173 54\n82             174 54\n83             175 54\n84             176 51\n85             177 NA\n86             178 54\n87             179 54\n88             180 54\n89             181 54\n90             182 54\n91             183 54\n92             184 54\n93             185 NA\n94             186 54\n95             187 54\n96             188 54\n97             189 54\n98             190 54\n99             191 54\n100            192 54\n101            193 54\n102            194 54\n103            195 54\n104            196 54\n105            197 54\n106            198 54\n107            199 54\n108            200 54\n109            201 54\n110            202 54\n111            203 54\n112            204 54\n113            205 54\n114            206 54\n115            207 54\n116            208 54\n117            209 54\n118            210 27\n119            211 24\n120            212 54\n121            213 NA\n122            214 54\n123            215 54\n124            216 54\n125            217 54\n126            218 54\n127            219 54\n128            220 54\n129            221 54\n130            222 27\n131            223 27\n132            224 54\n133            225 54\n134            226 54\n135            227 54\n136            228 51\n137            229 54\n138            230 27\n139            231 27\n140            232 54\n141            233 54\n142            234 54\n143            235 54\n144            236 54\n145            237 54\n146            238 54\n147            239 54\n148            240 54\n149            241 54\n150            242 45\n151            243 54\n```\n:::\n:::\n\n\n#### Check which collections are doubled\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#check which collections are doubled\ncount_n2_cfx %>% filter(n==108)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] collection_num n             \n<0 rows> (or 0-length row.names)\n```\n:::\n:::\n\n\n#### Count observations for each biological replicate\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each sample id/biological rep, then visualize\nn2_cfx_v2 %>% count(sample_id) %>% ggplot(aes(n)) + \n  geom_histogram() #there should be 3 technical reps\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#almost all have 3 replicates, but there is a small amount with 6 and some with 2\n\n#check which collections have more than 3 technical reps\nn2_cfx_v2 %>% count(sample_id) %>% filter(n>3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  sample_id      n\n  <chr>      <int>\n1 CC_191_E       6\n2 MI_144_DEF     6\n3 MI_98_D        6\n```\n:::\n:::\n\n\n#### Count observations for each collection number\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection date, then visualize\nn2_cfx_v2 %>% count(collection_num) %>% ggplot(aes(n)) +\n  geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n\n```{.r .cell-code}\nn2_cfx_v2 %>% ggplot(aes(collection_num)) + \n  geom_histogram(binwidth = 1) #max should be 54\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-17-2.png){width=672}\n:::\n:::\n\n\n### Plant data\n\n#### Merge data with number tibble to check missing collections\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#count observations for each collection number\n#merge with numbers tibble to check for missing collections\ncount_plant <- plant_v2 %>% count(Collection, date) \ncount_plant <- merge(count_plant, numbers3_tbl, by=\"Collection\", all.y=T)\ncount_plant\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    Collection       date  n\n1            7 2020-06-30  3\n2            8 2020-07-07  3\n3            9 2020-07-14  3\n4           10 2020-07-21  3\n5           11 2020-07-28  3\n6           12 2020-08-04  3\n7           13 2020-08-11  3\n8           14 2020-08-18  3\n9           15 2020-08-25  3\n10          16 2020-09-01  3\n11          17 2020-09-08  3\n12          18 2020-09-15  3\n13          19 2020-09-22  3\n14          20 2020-09-29  3\n15          21 2020-10-06  3\n16          22 2020-10-13  3\n17          23 2020-10-20  3\n18          24 2020-10-27  3\n19          25 2020-11-02  3\n20          26 2020-11-04  3\n21          27 2020-11-09  3\n22          28 2020-11-11  3\n23          29 2020-11-16  3\n24          30 2020-11-18  3\n25          31 2020-11-23  3\n26          32 2020-11-25  3\n27          33 2020-11-30  3\n28          34 2020-12-02  3\n29          35 2020-12-07  3\n30          36 2020-12-09  3\n31          37 2020-12-14  3\n32          38 2020-12-16  3\n33          39 2020-12-21  3\n34          40 2020-12-23  3\n35          41 2020-12-28  3\n36          42 2021-01-04  3\n37          43 2021-01-11  3\n38          44 2021-01-13  3\n39          45 2021-01-19  3\n40          46 2021-01-20  3\n41          47 2021-01-25  3\n42          48 2021-01-27  3\n43          49 2021-02-01  3\n44          50 2021-02-03  3\n45          51 2021-02-08  3\n46          52 2021-02-10  3\n47          53 2021-02-15  3\n48          54 2021-02-17  3\n49          55 2021-02-22  3\n50          56 2021-02-24  3\n51          57 2021-03-01  3\n52          58 2021-03-03  3\n53          59 2021-03-08  3\n54          60 2021-03-10  3\n55          61 2021-03-15  3\n56          62 2021-03-17  3\n57          63 2021-03-22  3\n58          64 2021-03-24  3\n59          65 2021-03-29  3\n60          66 2021-03-31  3\n61          67 2021-04-05  3\n62          68 2021-04-07  3\n63          69 2021-04-12  3\n64          70 2021-04-14  3\n65          71 2021-04-19  3\n66          72 2021-04-21  3\n67          73 2021-04-26  3\n68          74 2021-04-28  3\n69          75 2021-05-03  3\n70          76 2021-05-05  3\n71          77 2021-05-10  3\n72          78 2021-05-12  3\n73          79 2021-05-17  3\n74          80 2021-05-19  3\n75          81 2021-05-24  3\n76          82 2021-05-26  3\n77          83 2021-06-01  3\n78          84 2021-06-02  3\n79          85 2021-06-07  3\n80          86 2021-06-09  3\n81          87 2021-06-14  3\n82          88 2021-06-16  3\n83          89 2021-06-21  3\n84          90 2021-06-23  3\n85          91 2021-06-28  3\n86          92 2021-06-30  3\n87          93 2021-07-06  3\n88          94 2021-07-07  3\n89          95 2021-07-12  3\n90          96 2021-07-14  3\n91          97 2021-07-19  3\n92          98 2021-07-21  3\n93          99 2021-07-26  3\n94         100 2021-07-28  3\n95         101 2021-08-02  3\n96         102 2021-08-04  3\n97         103 2021-08-09  3\n98         104 2021-08-11  3\n99         105 2021-08-16  3\n100        106 2021-08-18  3\n101        107 2021-08-23  3\n102        108 2021-08-25  3\n103        109 2021-08-30  3\n104        110 2021-09-01  3\n105        111 2021-09-07  3\n106        112 2021-09-08  3\n107        113 2021-09-13  3\n108        114 2021-09-15  3\n109        115 2021-09-20  3\n110        116 2021-09-22  3\n111        117 2021-09-27  3\n112        118 2021-09-29  3\n113        119 2021-10-04  3\n114        120 2021-10-06  3\n115        121 2021-10-11  3\n116        122 2021-10-13  3\n117        123 2021-10-18  3\n118        124 2021-10-20  3\n119        125 2021-10-25  3\n120        126 2021-10-27  3\n121        127 2021-11-01  3\n122        128 2021-11-03  3\n123        129 2021-11-08  3\n124        130 2021-11-10  3\n125        131 2021-11-15  3\n126        132 2021-11-17  3\n127        133 2021-11-22  3\n128        134 2021-11-29  3\n129        135 2021-12-01  3\n130        136 2021-12-06  3\n131        137 2021-12-08  3\n132        138 2021-12-13  3\n133        139 2021-12-15  3\n134        140 2021-12-20  3\n135        141 2021-12-27  3\n136        142 2022-01-03  3\n137        143 2022-01-05  3\n138        144 2022-01-10  3\n139        145 2022-01-12  3\n140        146 2022-01-17  3\n141        147 2022-01-19  3\n142        148 2022-01-24  3\n143        149 2022-01-26  3\n144        150 2022-01-31  3\n145        151 2022-02-02  3\n146        152 2022-02-07  3\n147        153 2022-02-09  3\n148        154 2022-02-14  3\n149        155 2022-02-16  3\n150        156 2022-02-21  3\n151        157 2022-02-23  3\n152        158 2022-02-28  3\n153        159 2022-03-02  3\n154        160 2022-03-07  3\n155        161 2022-03-09  3\n156        162 2022-03-14  3\n157        163 2022-03-16  3\n158        164 2022-03-21  3\n159        165 2022-03-23  3\n160        166 2022-03-28  3\n161        167 2022-03-30  3\n162        168 2022-04-04  3\n163        169 2022-04-06  3\n164        170 2022-04-11  3\n165        171 2022-04-13  3\n166        172 2022-04-18  3\n167        173 2022-04-20  3\n168        174 2022-04-25  3\n169        175 2022-04-27  3\n170        176 2022-05-02  3\n171        177       <NA> NA\n172        178 2022-05-09  3\n173        179 2022-05-11  3\n174        180 2022-05-16  3\n175        181 2022-05-18  3\n176        182 2022-05-23  3\n177        183 2022-05-25  3\n178        184 2022-05-31  3\n179        185 2022-06-01  3\n180        186 2022-06-06  3\n181        187 2022-06-08  3\n182        188 2022-06-13  3\n183        189 2022-06-15  3\n184        190 2022-06-20  3\n185        191 2022-06-22  3\n186        192 2022-06-27  3\n187        193 2022-06-29  3\n188        194 2022-07-04  3\n189        195 2022-07-06  3\n190        196 2022-07-11  3\n191        197 2022-07-13  3\n192        198 2022-07-18  3\n193        199 2022-07-20  3\n194        200 2022-07-25  3\n195        201 2022-07-27  3\n196        202 2022-08-01  3\n197        203 2022-08-03  3\n198        204 2022-08-08  3\n199        205 2022-08-10  3\n200        206 2022-08-15  3\n201        207 2022-08-17  3\n202        208 2022-08-22  3\n203        209 2022-08-24  3\n204        210 2022-08-29  3\n205        211 2022-08-31  3\n206        212 2022-09-05  3\n207        213 2022-09-07  3\n208        214 2022-09-13  3\n209        215 2022-09-14  3\n210        216 2022-09-19  3\n211        217 2022-09-21  3\n212        218 2022-09-26  3\n213        219 2022-09-28  3\n214        220 2022-10-03  3\n215        221 2022-10-05  3\n216        222 2022-10-10  3\n217        223 2022-10-12  3\n218        224 2022-10-17  3\n219        225 2022-10-19  3\n220        226 2022-10-24  3\n221        227 2022-10-26  3\n222        228 2022-10-31  3\n223        229 2022-11-02  3\n224        230 2022-11-07  3\n225        231 2022-11-09  3\n226        232 2022-11-14  3\n227        233 2022-11-16  3\n228        234 2022-11-21  3\n229        235 2022-11-28  3\n230        236 2022-11-30  3\n231        237 2022-12-05  3\n232        238 2022-12-07  3\n233        239 2022-12-12  3\n234        240 2022-12-14  3\n235        241 2022-12-19  3\n236        242 2022-12-21  3\n237        243 2023-01-04  3\n```\n:::\n:::\n\n\n#### Count observations for each collection date\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplant_v2 %>% ggplot(aes(Collection)) + \n  geom_histogram(binwidth = 1) #max should be 3\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n## Cleaning and merging\n\n### qPCR data\n\n#### Select for important variables, convert non-detects to NAs\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Select date, collection number, sample id/bio rep, target, and ct\n#Convert Undetermined Cts to NAs\n\n#StepOne N1\nn1_stepone_clean <- n1_stepone_v2 %>% select(c(sample_date, collection_num, sample_id, target, ct)) %>% \n  mutate(ct=as.numeric(ifelse(ct==\"Undetermined\", NA, ct)))\n\n#StepOne N2\nn2_stepone_clean <- n2_stepone_v2 %>% select(c(sample_date, collection_num, sample_id, target, ct)) %>% \n  mutate(ct=as.numeric(ifelse(ct==\"Undetermined\", NA, ct)))\n\n#CFX N1\nn1_cfx_clean <- n1_cfx_v2 %>% select(c(sample_date, collection_num, sample_id, target, ct)) %>% \n  mutate(ct=as.numeric(ifelse(ct==\"Undetermined\", NA, ct)))\n\n#CFX N2\nn2_cfx_clean <- n2_cfx_v2 %>% select(c(sample_date, collection_num, sample_id, target, ct)) %>% \n  mutate(ct=as.numeric(ifelse(ct==\"Undetermined\", NA, ct)))\n```\n:::\n\n\n#### Bind qPCR NA data sets\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Bind qpcr data\nqpcr_na <- bind_rows(n1_stepone_clean, n2_stepone_clean, n1_cfx_clean, n2_cfx_clean) %>% \n  mutate(\n    date = sample_date,\n    facility=substr(sample_id, 1,2), #first two letters in sample_id is treatment facility ID\n    biological_replicate=substr(sample_id, nchar(sample_id), nchar(sample_id))) %>% #last number in sample_id is the biological rep\n arrange(date, facility, target, biological_replicate) %>% \n  select(date, facility, target, biological_replicate, collection_num, ct)#select necessary variables\n  \n#Save to processed data folder\nsaveRDS(qpcr_na, here(\"data/processed_data/qpcr_na.rds\"))\n```\n:::\n\n\n#### Calculate LOD and LOQ for qPCR data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Determine the LOD and LOQ by plotting the Normal QQ-Plot\nqqnorm.ct.n1.stepone <- qqnorm(n1_stepone_clean$ct, plot.it = T) %>% as.data.frame()\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n\n```{.r .cell-code}\nqqnorm.ct.n2.stepone <- qqnorm(n2_stepone_clean$ct, plot.it = T) %>% as.data.frame()\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-22-2.png){width=672}\n:::\n\n```{.r .cell-code}\nqqnorm.ct.n1.cfx <- qqnorm(n1_cfx_clean$ct, plot.it = T) %>% as.data.frame()\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-22-3.png){width=672}\n:::\n\n```{.r .cell-code}\nqqnorm.ct.n2.cfx <- qqnorm(n2_cfx_clean$ct, plot.it = T) %>% as.data.frame()\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-22-4.png){width=672}\n:::\n\n```{.r .cell-code}\ntiff(filename = \"figures/detection_lims.tiff\", height = 9, width = 8, units = \"in\", res = 600)\n\n#Create function to compute LOD and lOQ\nqqnorm.Explorer.ct <- function(qqnorm.ct){\n  qqnorm.ct <- qqnorm.ct[which(complete.cases(qqnorm.ct)),]\n  qqnorm.ct <- qqnorm.ct[order(qqnorm.ct$x),]\n  qqnorm.ct <- cbind(qqnorm.ct, rbind(NA, qqnorm.ct[-nrow(qqnorm.ct),])) %>% setNames(., nm = c(\"x\", \"y\", \"x-1\", \"y-1\"))\n  qqnorm.ct %<>% mutate(rise = y-`y-1`, run = x-`x-1`) %>% mutate(slope = rise / run)\n  qqnorm.ct$lod <- NA\n  qqnorm.ct$loq <- NA\n  prev.slope <- 1\n  lod.found <- 0\n  for(i in nrow(qqnorm.ct):2){\n    if(lod.found==0){\n      if(qqnorm.ct$slope[i]<1 & prev.slope <1){\n        qqnorm.ct$lod[i] <- 1\n        lod.found <- 1\n      }else{\n        prev.slope <- qqnorm.ct$slope[i]\n      }\n    }\n    if(lod.found==1){\n      if(qqnorm.ct$slope[i]>1){\n        qqnorm.ct$loq[i] <- 1\n        break\n      }else{\n        prev.slope <- qqnorm.ct$slope[i]\n      }\n    }\n  }\n  lod.ct <- qqnorm.ct$y[which(qqnorm.ct$lod==1)]\n  loq.ct <- qqnorm.ct$y[which(qqnorm.ct$loq==1)]\n  return(list(qqnorm.dataset = qqnorm.ct, lod = lod.ct, loq = loq.ct))\n}\n\n#Run function on each data set\nqqnorm.ct.n1.stepone <- qqnorm.Explorer.ct(qqnorm.ct.n1.stepone)\nqqnorm.ct.n2.stepone <- qqnorm.Explorer.ct(qqnorm.ct.n2.stepone)\nqqnorm.ct.n1.cfx <- qqnorm.Explorer.ct(qqnorm.ct.n1.cfx)\nqqnorm.ct.n2.cfx <- qqnorm.Explorer.ct(qqnorm.ct.n2.cfx)\n\n#Save LOD and LOQ for each data set\nn1_stepone_lod <- qqnorm.ct.n1.stepone$lod\nn1_stepone_loq <- qqnorm.ct.n1.stepone$loq\nn2_stepone_lod <- qqnorm.ct.n2.stepone$lod\nn2_stepone_loq <- qqnorm.ct.n2.stepone$loq\n\nn1_cfx_lod <- qqnorm.ct.n1.cfx$lod\nn1_cfx_loq <- qqnorm.ct.n1.cfx$loq\nn2_cfx_lod <- qqnorm.ct.n2.cfx$lod\nn2_cfx_loq <- qqnorm.ct.n2.cfx$loq\n\nn1_stepone_lod\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 37.14072\n```\n:::\n\n```{.r .cell-code}\nn2_stepone_lod\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 37.10763\n```\n:::\n\n```{.r .cell-code}\nn1_cfx_lod \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 39.93763\n```\n:::\n\n```{.r .cell-code}\nn2_cfx_lod\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 39.9942\n```\n:::\n:::\n\n\n#### Transform Ct NAs to calculate SARS-CoV-2 copies\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Replace NAs with limit of detection\n#Use standard curve slope for each target to calculate copies per uL per rxn\n\n#StepOne N1\nn1_stepone_clean <- n1_stepone_clean %>% \n  mutate(ct = replace_na(ct, n1_stepone_lod),\n         copy_num_uL_rxn = as.numeric(10^((ct-34.008)/-3.389)))\n\n#StepOne N2\nn2_stepone_clean <- n2_stepone_clean %>% \n  mutate(ct = replace_na(ct, n2_stepone_lod),\n         copy_num_uL_rxn = as.numeric(10^((ct-32.416)/-3.3084)))\n\n#CFX N1\nn1_cfx_clean <- n1_cfx_clean %>% \n  mutate(ct = replace_na(ct, n1_cfx_lod), \n         copy_num_uL_rxn = as.numeric(10^((ct-36.046)/-3.5293)))\n\n#CFX N2\nn2_cfx_clean <- n2_cfx_clean %>% \n  mutate(ct = replace_na(ct, n2_cfx_lod),\n         copy_num_uL_rxn = as.numeric(10^((ct-37.731)/-3.2505)))\n```\n:::\n\n\n#### Quick look at Ct distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#N1 StepOne\nn1_stepone_clean %>% filter(ct<n1_stepone_lod) %>% ggplot(aes(ct)) + geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#N2 StepOne\nn2_stepone_clean %>% filter(ct<n2_stepone_lod) %>% ggplot(aes(ct)) + geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-24-2.png){width=672}\n:::\n\n```{.r .cell-code}\n#N1 CFX\nn1_cfx_clean %>% filter(ct<n1_cfx_lod) %>% ggplot(aes(ct)) + geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-24-3.png){width=672}\n:::\n\n```{.r .cell-code}\n#N2 CFX\nn2_cfx_clean %>% filter(ct<n2_cfx_lod) %>% ggplot(aes(ct)) + geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-24-4.png){width=672}\n:::\n\n```{.r .cell-code}\n#loooooots of non-detects\n```\n:::\n\n\n#### Bind all qPCR data sets\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Bind qpcr data\nqpcr_all <- bind_rows(n1_stepone_clean, n2_stepone_clean, n1_cfx_clean, n2_cfx_clean) %>% \n  mutate(\n    date = sample_date,\n    facility=substr(sample_id, 1,2), #first two letters in sample_id is treatment facility ID\n    biological_replicate=substr(sample_id, nchar(sample_id), nchar(sample_id))) %>% #last number in sample_id is the biological rep\n arrange(date, facility, target, biological_replicate) %>% \n  select(date, facility, target, biological_replicate, collection_num, ct, copy_num_uL_rxn)#select necessary variables\n  \n#Save to processed data folder\nsaveRDS(qpcr_all, here(\"data/processed_data/qpcr_all.rds\"))\n```\n:::\n\n\n### Combine plant and qPCR data sets\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Change plant variable names to match qPCR names, remove notes variable, convert millions of gallons to liters\nplant_v2<- plant_v2 %>% rename(collection_num = Collection, facility = wrf) %>% \n  select(!notes) %>% \n  mutate(influent_flow_L = influent_flow_mg*1e6*231*(0.0254^3)*1000)\n\n#Select qPCR variables to merge\n#qpcr_all <- qpcr_all %>% select(!date)\n\n#Merge and mutate\nqpcr_plant_all <- merge(qpcr_all, plant_v2, by = c(\"collection_num\", \"facility\", \"date\"), all = T) %>% \n  mutate(facility = as.factor(facility), #code each facility as a factor\n         facility = recode(facility, NO = \"A\", MI = \"B\", CC = \"C\"), #de-identify treatment facility\n         facility = ordered(facility, levels = c(\"A\", \"B\", \"C\")), #set facility factor levels\n         copy_num_L = copy_num_uL_rxn*20/5*60/280*1000*1000,\n         viral_load = copy_num_L*influent_flow_L) #transform copies per uL of reaction to copies per liter\n\n#Save to processed data folder\nsaveRDS(qpcr_plant_all, here(\"data/processed_data/qpcr_plant_all.rds\"))\n```\n:::\n\n\n### Quick look at WBE data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Filter for correct date range, then visualize observations for each collection\nqpcr_plant_all %>% filter(between(collection_num, 7, 243)) %>% \n  ggplot(aes(collection_num)) +\n  geom_bar()\n```\n\n::: {.cell-output-display}\n![](1_initial_cleaning_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#which observations are low?\nqpcr_plant_all %>% count(collection_num) %>% \n  filter(between(collection_num, 7, 243), n < 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  collection_num n\n1             40 3\n2             94 3\n3            135 3\n4            213 3\n```\n:::\n:::\n\n\n### Combine DPH COVID data sets\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncovid <- full_join(\n  covid_symptom%>%\n    select(cases.symptom.onset=cases, date=symptom.date), \n  covid_case%>%\n    select(cases.reported=cases, date=report_date), \n  by = \"date\"\n) %>% \n  full_join(\n    covid_testing%>%\n      rename(date=collection_date), \n    by=\"date\"\n  ) %>%\n  select(date, cases.symptom.onset, cases.reported, pcr_tests, pcr_pos, pcr_pos_7dma, pcr_pos_14dma) %>% \n\n  mutate(prop_pos = pcr_pos/pcr_tests)\n\n#Save to processed data folder\nsaveRDS(covid, here(\"data/processed_data/all_covid_combined.rds\"))\ncovid\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1,090 × 8\n   date       cases.symptom.on…¹ cases…² pcr_t…³ pcr_pos pcr_p…⁴ pcr_p…⁵ prop_…⁶\n   <date>                  <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>\n 1 2020-02-01                  0       0       0       0      NA      NA     NaN\n 2 2020-02-02                  0       0       0       0      NA      NA     NaN\n 3 2020-02-03                  0       0       0       0      NA      NA     NaN\n 4 2020-02-04                  0       0       0       0      NA      NA     NaN\n 5 2020-02-05                  0       0       0       0      NA      NA     NaN\n 6 2020-02-06                  0       0       0       0      NA      NA     NaN\n 7 2020-02-07                  0       0       0       0       0      NA     NaN\n 8 2020-02-08                  0       0       0       0       0      NA     NaN\n 9 2020-02-09                  0       0       0       0       0      NA     NaN\n10 2020-02-10                  1       0       0       0       0      NA     NaN\n# … with 1,080 more rows, and abbreviated variable names ¹​cases.symptom.onset,\n#   ²​cases.reported, ³​pcr_tests, ⁴​pcr_pos_7dma, ⁵​pcr_pos_14dma, ⁶​prop_pos\n```\n:::\n:::\n\n\n## Filter hospitalization data\n\nFilter for state of GA, city of Athens, and for appropriate dates\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#athens_hospitalizations <- hospitalization %>% \n  #filter(state==\"GA\", city==\"ATHENS\", between(collection_week, as.Date(\"2020-06-28\"), as.Date(\"2023-01-08\")))\n\n#Save to processed data folder\n#saveRDS(athens_hospitalizations, here(\"data/processed_data/athens_hospitalizations.rds\"))\n```\n:::\n\n\n### Combine WBE and COVID data sets\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwbe_covid <- merge(qpcr_plant_all, covid, by = \"date\", all = T) %>% \n  filter(between(date, as.Date(\"2020-06-30\"), as.Date(\"2023-01-04\")))\n\n#I didn't save this because I probably won't use it, we can combine later in script 2\n```\n:::\n",
    "supporting": [
      "1_initial_cleaning_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}